import numpy
from numpy import array, where

from . import gmix

def make_joint_prior_bdf_great3():
    p=JointPriorBDFGreat3(_great3_bdf_weights,
                          _great3_bdf_means,
                          _great3_bdf_covars)
    return p

class JointPriorBDFGreat3(gmix.GMixND):
    """
    Joint prior in g1,g2,T,Fb,Fd

    The prior is actually in eta1,eta2,logT,logFb,logFd
    as a sum of gaussians
    """
    def __init__(self,
                 weights,
                 means,
                 covars,
                 logT_bounds=[-1.6, 1.0],
                 logFlux_bounds=[-3.0, 2.0]):

        super(JointPriorBDFGreat3,self).__init__(weights, means, covars)

        self.logT_bounds=logT_bounds
        self.logFlux_bounds=logFlux_bounds
        self._make_gmm()

    def sample(self, n):
        """
        Get samples in linear space
        """
        from .shape import eta1eta2_to_g1g2_array

        logT_bounds = self.logT_bounds
        logFlux_bounds = self.logFlux_bounds

        lin_samples=numpy.zeros( (n,self.ndim) )
        nleft=n
        ngood=0
        while nleft > 0:
            log_samples=self.gmm.sample(nleft)

            eta1,eta2 = log_samples[:,0], log_samples[:,1]
            g1,g2,g_good = eta1eta2_to_g1g2_array(eta1, eta2)

            logT = log_samples[:,2]
            logFb = log_samples[:,3]
            logFd = log_samples[:,4]
            
            w, = where(  (g_good == 1)
                       & (logT > logT_bounds[0])
                       & (logT < logT_bounds[1])
                       & (logFb > logFlux_bounds[0])
                       & (logFb < logFlux_bounds[1])
                       & (logFd > logFlux_bounds[0])
                       & (logFd < logFlux_bounds[1]) )

            if w.size > 0:
                first=ngood
                last=ngood+w.size

                T = 10.0**logT[w]
                Fb = 10.0**logFb[w]
                Fd = 10.0**logFd[w]

                lin_samples[first:last,0] = g1[w]
                lin_samples[first:last,1] = g2[w]
                lin_samples[first:last,2] = T
                lin_samples[first:last,3] = Fb
                lin_samples[first:last,4] = Fd

                ngood += w.size
                nleft -= w.size

        return lin_samples


    def _make_gmm(self):
        """
        Make a GMM object for sampling
        """
        from sklearn.mixture import GMM

        # these numbers are not used because we set the means, etc by hand
        ngauss=self.weights.size
        gmm=GMM(n_components=self.ngauss,
                n_iter=10000,
                min_covar=1.0e-12,
                covariance_type='full')
        gmm.means_ = self.means
        gmm.covars_ = self.covars
        gmm.weights_ = self.weights

        self.gmm=gmm 


_great3_bdf_weights  = array([ 0.03690278,  0.07463067,  0.04683234,  0.04177728,  0.06966931,
        0.03392204,  0.06299521,  0.01155707,  0.01808902,  0.0361671 ,
        0.0578418 ,  0.06481369,  0.12139426,  0.04543187,  0.06070758,
        0.03563261,  0.02388136,  0.01281651,  0.06233556,  0.08260194])

_great3_bdf_means = array([[  1.08541445e-01,   6.11764246e-02,  -5.01296864e-01,
         -1.31821693e+00,   3.68175574e-01],
       [  6.79855886e-03,  -1.05267746e-03,  -6.04261597e-01,
         -9.67542223e-01,  -2.45197103e-01],
       [  1.38001552e-02,   9.32070016e-03,  -3.42316714e-01,
         -2.65335065e-01,   2.18813203e-01],
       [  6.44720874e-03,  -2.89598354e-02,  -8.03837991e-01,
         -1.18098046e+00,  -3.72218325e-01],
       [  1.61120274e-01,  -1.10324803e-01,  -6.49797073e-01,
         -1.58910162e+00,   9.08425530e-02],
       [  2.40476674e-02,   2.65869433e-02,  -6.51107713e-01,
         -4.91241406e-01,  -5.73715518e-01],
       [ -2.30335969e-02,   5.91528280e-02,  -6.27890771e-01,
         -8.06115949e-01,   1.18550825e-01],
       [ -2.17274536e-03,  -4.83242298e-04,  -2.03121500e-01,
          8.92758399e-01,  -1.64544706e+00],
       [ -8.92027776e-02,  -4.86357195e-01,  -3.02718393e-01,
         -1.74468605e+00,   9.38708755e-02],
       [ -1.11068592e-03,   8.04521145e-03,  -6.43448258e-01,
         -1.51451898e+00,   2.00781551e-01],
       [  3.34230604e-02,  -1.40600261e-02,  -6.91030215e-01,
         -9.31637572e-01,  -3.69164422e-01],
       [  6.27366683e-03,  -3.62063833e-04,  -4.52042292e-01,
         -5.02107754e-01,   6.72448530e-02],
       [ -1.05014335e-02,  -2.24681472e-02,  -4.45041980e-01,
         -5.89428277e-01,  -1.01727503e-01],
       [ -5.06635325e-02,  -9.86164192e-03,  -8.10862522e-01,
         -1.40675669e+00,  -1.39579236e-01],
       [ -2.01120325e-02,   1.07441154e-02,  -5.31007888e-01,
         -7.17831928e-01,  -2.81682732e-01],
       [ -1.78523024e-02,   6.76787488e-03,  -8.42309764e-01,
         -4.76359054e-01,  -1.63290814e-01],
       [  5.82569758e-03,  -1.74237317e-03,  -4.29937399e-01,
          4.31570467e-02,  -7.13846212e-01],
       [  3.71830812e-03,  -1.15276820e-02,   1.22060236e-01,
          1.95744974e-02,  -9.14617973e-01],
       [ -4.98206112e-02,   2.07056162e-02,  -8.64889714e-01,
         -9.94833284e-01,  -2.59033800e-01],
       [ -1.04931374e-01,   1.32903942e-01,  -5.57481329e-01,
         -1.32860517e+00,   6.69801688e-03]])



_great3_bdf_covars = array([[[  2.55297986e-01,  -2.49852700e-02,  -1.48801262e-02,
          -3.07460385e-03,  -5.38089347e-03],
        [ -2.49852700e-02,   2.87820486e-01,   8.16068682e-04,
          -2.24021377e-02,  -9.83879907e-04],
        [ -1.48801262e-02,   8.16068682e-04,   5.24436716e-02,
          -3.85182008e-02,   1.29147396e-02],
        [ -3.07460385e-03,  -2.24021377e-02,  -3.85182008e-02,
           2.26943996e-01,  -2.78902681e-02],
        [ -5.38089347e-03,  -9.83879907e-04,   1.29147396e-02,
          -2.78902681e-02,   1.08089845e-02]],

       [[  6.37181393e-02,  -1.88389208e-03,   1.74673249e-03,
           2.38780391e-04,  -4.65481112e-04],
        [ -1.88389208e-03,   6.98624699e-02,   3.39644182e-03,
          -1.07695616e-03,  -1.14376565e-03],
        [  1.74673249e-03,   3.39644182e-03,   3.16130611e-02,
          -3.18535331e-03,   1.08506244e-02],
        [  2.38780391e-04,  -1.07695616e-03,  -3.18535331e-03,
           1.15065813e-01,  -4.93669468e-02],
        [ -4.65481112e-04,  -1.14376565e-03,   1.08506244e-02,
          -4.93669468e-02,   4.07485711e-02]],

       [[  2.87782720e-01,   8.04469291e-03,   3.23167300e-04,
           5.85092718e-04,  -1.52978981e-03],
        [  8.04469291e-03,   3.13468485e-01,   3.71124169e-03,
          -2.73503292e-03,   8.96821115e-04],
        [  3.23167300e-04,   3.71124169e-03,   6.88053153e-02,
           6.59764259e-03,   1.88723197e-02],
        [  5.85092718e-04,  -2.73503292e-03,   6.59764259e-03,
           4.50202045e-02,  -1.30424890e-02],
        [ -1.52978981e-03,   8.96821115e-04,   1.88723197e-02,
          -1.30424890e-02,   1.87844230e-02]],

       [[  7.24648746e-01,   1.73775930e-02,  -1.92332006e-03,
          -1.53037544e-02,   4.00780561e-03],
        [  1.73775930e-02,   7.38851551e-01,   6.32764569e-03,
           4.68006627e-03,  -4.86130145e-03],
        [ -1.92332006e-03,   6.32764569e-03,   2.37904328e-02,
          -2.01980635e-02,   9.53734774e-03],
        [ -1.53037544e-02,   4.68006627e-03,  -2.01980635e-02,
           4.99315345e-02,  -2.15536565e-02],
        [  4.00780561e-03,  -4.86130145e-03,   9.53734774e-03,
          -2.15536565e-02,   1.30255557e-02]],

       [[  3.92051348e-01,  -2.02922710e-03,   6.49248109e-03,
           1.93699679e-02,  -2.22157698e-02],
        [ -2.02922710e-03,   3.34869069e-01,  -2.01907472e-03,
          -1.26508689e-02,   7.30481127e-04],
        [  6.49248109e-03,  -2.01907472e-03,   3.52152191e-02,
          -5.52251721e-02,   1.30602267e-02],
        [  1.93699679e-02,  -1.26508689e-02,  -5.52251721e-02,
           1.48411822e-01,  -5.25505710e-02],
        [ -2.22157698e-02,   7.30481127e-04,   1.30602267e-02,
          -5.25505710e-02,   3.93235648e-02]],

       [[  3.88298625e-01,   1.13492204e-02,  -7.91096852e-03,
          -9.63219428e-03,   1.23980969e-02],
        [  1.13492204e-02,   3.34372182e-01,  -3.61803903e-03,
          -4.44974559e-03,   1.24418397e-02],
        [ -7.91096852e-03,  -3.61803903e-03,   3.51228096e-02,
           1.52810892e-02,  -2.67209566e-02],
        [ -9.63219428e-03,  -4.44974559e-03,   1.52810892e-02,
           2.82924317e-02,  -3.53938366e-02],
        [  1.23980969e-02,   1.24418397e-02,  -2.67209566e-02,
          -3.53938366e-02,   1.05170238e-01]],

       [[  2.90885995e-01,   9.22117126e-03,   6.86666103e-03,
           2.19297684e-02,  -1.37306552e-02],
        [  9.22117126e-03,   2.61845902e-01,   1.01252089e-02,
          -1.01328367e-02,  -6.12568119e-03],
        [  6.86666103e-03,   1.01252089e-02,   2.59726748e-02,
           4.53030366e-03,  -2.54919037e-03],
        [  2.19297684e-02,  -1.01328367e-02,   4.53030366e-03,
           1.90960533e-01,  -3.70110277e-02],
        [ -1.37306552e-02,  -6.12568119e-03,  -2.54919037e-03,
          -3.70110277e-02,   1.85810120e-02]],

       [[  7.28941879e-02,  -1.03277044e-02,   1.07997994e-03,
           4.77531725e-04,   3.98862212e-03],
        [ -1.03277044e-02,   8.30502291e-02,   1.54421374e-03,
          -8.35312069e-04,   3.32858581e-03],
        [  1.07997994e-03,   1.54421374e-03,   4.55549752e-02,
           3.24428678e-02,   5.00588108e-02],
        [  4.77531725e-04,  -8.35312069e-04,   3.24428678e-02,
           1.13243920e-01,   3.17059617e-03],
        [  3.98862212e-03,   3.32858581e-03,   5.00588108e-02,
           3.17059617e-03,   3.79240301e-01]],

       [[  7.34333655e-01,  -3.51462028e-02,   1.68309470e-02,
          -1.46249001e-02,   1.19739140e-02],
        [ -3.51462028e-02,   7.83461417e-01,   8.89262866e-02,
          -9.51095553e-02,   8.48375684e-02],
        [  1.68309470e-02,   8.89262866e-02,   5.56132249e-02,
          -5.75164632e-02,   4.88099340e-02],
        [ -1.46249001e-02,  -9.51095553e-02,  -5.75164632e-02,
           1.72938886e-01,  -9.48094731e-02],
        [  1.19739140e-02,   8.48375684e-02,   4.88099340e-02,
          -9.48094731e-02,   8.22959587e-02]],

       [[  3.11676293e-02,   2.99218474e-03,   1.11947396e-04,
          -1.10096559e-03,   5.34663432e-04],
        [  2.99218474e-03,   3.24335118e-02,   7.55850677e-04,
          -2.24246259e-03,  -1.23717150e-03],
        [  1.11947396e-04,   7.55850677e-04,   5.05782673e-02,
          -6.90896755e-02,   2.09325942e-02],
        [ -1.10096559e-03,  -2.24246259e-03,  -6.90896755e-02,
           1.77619345e-01,  -4.63654902e-02],
        [  5.34663432e-04,  -1.23717150e-03,   2.09325942e-02,
          -4.63654902e-02,   3.34903792e-02]],

       [[  6.77610840e-01,  -3.13486429e-02,   5.30373194e-03,
          -1.16266986e-02,   9.30204018e-03],
        [ -3.13486429e-02,   6.68016261e-01,   1.14281821e-02,
          -1.20067871e-02,   5.34536099e-03],
        [  5.30373194e-03,   1.14281821e-02,   3.63937677e-02,
          -5.25253892e-03,   5.45683651e-03],
        [ -1.16266986e-02,  -1.20067871e-02,  -5.25253892e-03,
           4.69147626e-02,  -3.30536775e-02],
        [  9.30204018e-03,   5.34536099e-03,   5.45683651e-03,
          -3.30536775e-02,   3.49327629e-02]],

       [[  3.64705043e-02,  -3.36824753e-04,  -6.99296926e-04,
          -6.52753142e-04,  -1.19593437e-03],
        [ -3.36824753e-04,   4.14777213e-02,   1.79937965e-03,
           7.84353038e-04,   8.96956170e-04],
        [ -6.99296926e-04,   1.79937965e-03,   6.59216816e-02,
           4.07414891e-02,   1.17265951e-02],
        [ -6.52753142e-04,   7.84353038e-04,   4.07414891e-02,
           1.14199323e-01,  -8.42424613e-03],
        [ -1.19593437e-03,   8.96956170e-04,   1.17265951e-02,
          -8.42424613e-03,   3.76177398e-02]],

       [[  3.65610404e-01,   2.12793282e-03,   4.47243347e-03,
          -2.56974662e-03,  -1.52983184e-03],
        [  2.12793282e-03,   3.66815435e-01,   1.07346722e-02,
           1.90835512e-03,  -3.51533517e-03],
        [  4.47243347e-03,   1.07346722e-02,   4.80550560e-02,
           2.52926393e-02,   3.67061329e-04],
        [ -2.56974662e-03,   1.90835512e-03,   2.52926393e-02,
           1.44638110e-01,  -2.47181737e-02],
        [ -1.52983184e-03,  -3.51533517e-03,   3.67061329e-04,
          -2.47181737e-02,   4.30896729e-02]],

       [[  4.45661175e-01,   5.10547628e-02,  -2.69983856e-03,
          -4.16962451e-03,   1.67944023e-03],
        [  5.10547628e-02,   4.55653437e-01,   1.07051110e-03,
          -1.57617492e-03,  -3.31318571e-03],
        [ -2.69983856e-03,   1.07051110e-03,   1.88708248e-02,
          -2.84997868e-02,   8.87860281e-03],
        [ -4.16962451e-03,  -1.57617492e-03,  -2.84997868e-02,
           6.99482007e-02,  -2.61926652e-02],
        [  1.67944023e-03,  -3.31318571e-03,   8.87860281e-03,
          -2.61926652e-02,   1.73891347e-02]],

       [[  3.38332096e-01,   4.11239397e-04,   2.95781482e-03,
           1.01696492e-02,  -8.72268027e-03],
        [  4.11239397e-04,   4.11722695e-01,   2.47552017e-04,
          -4.27876837e-03,   4.37120871e-03],
        [  2.95781482e-03,   2.47552017e-04,   6.00653842e-02,
           3.09944513e-02,  -3.04551234e-02],
        [  1.01696492e-02,  -4.27876837e-03,   3.09944513e-02,
           4.01523207e-02,  -3.30014931e-02],
        [ -8.72268027e-03,   4.37120871e-03,  -3.04551234e-02,
          -3.30014931e-02,   5.15528330e-02]],

       [[  1.80858208e-01,   2.34345674e-03,  -4.86504080e-03,
          -6.74006743e-03,  -6.90264165e-04],
        [  2.34345674e-03,   1.78609581e-01,   4.51555449e-03,
           2.54962913e-03,   7.20147078e-04],
        [ -4.86504080e-03,   4.51555449e-03,   1.71913593e-02,
           3.07918214e-02,  -9.16914838e-03],
        [ -6.74006743e-03,   2.54962913e-03,   3.07918214e-02,
           1.08217218e-01,  -3.05005732e-02],
        [ -6.90264165e-04,   7.20147078e-04,  -9.16914838e-03,
          -3.05005732e-02,   3.70913409e-02]],

       [[  7.44188384e-02,  -5.63503802e-03,  -2.04403785e-03,
           8.55154699e-04,  -2.04017192e-03],
        [ -5.63503802e-03,   7.32559946e-02,   1.15008212e-03,
          -2.65256683e-04,  -3.28530705e-03],
        [ -2.04403785e-03,   1.15008212e-03,   5.51365166e-02,
           1.52460427e-02,  -2.10284483e-02],
        [  8.55154699e-04,  -2.65256683e-04,   1.52460427e-02,
           4.65588155e-02,   2.77368816e-03],
        [ -2.04017192e-03,  -3.28530705e-03,  -2.10284483e-02,
           2.77368816e-03,   1.84135695e-01]],

       [[  3.21534987e-01,   7.05322443e-02,   2.89086097e-03,
          -3.47425646e-03,   4.59484896e-03],
        [  7.05322443e-02,   3.34464446e-01,   4.42159018e-03,
          -1.76743738e-03,  -1.82577078e-03],
        [  2.89086097e-03,   4.42159018e-03,   1.27598049e-01,
          -3.16551322e-02,   8.67184165e-02],
        [ -3.47425646e-03,  -1.76743738e-03,  -3.16551322e-02,
           8.85082988e-02,  -7.23707361e-02],
        [  4.59484896e-03,  -1.82577078e-03,   8.67184165e-02,
          -7.23707361e-02,   2.92559885e-01]],

       [[  1.92703058e-01,  -2.21970420e-02,  -2.64576171e-03,
           1.79502029e-03,  -7.13672371e-03],
        [ -2.21970420e-02,   2.02827850e-01,   3.80655995e-03,
           5.95901276e-03,  -1.98922438e-03],
        [ -2.64576171e-03,   3.80655995e-03,   1.20828477e-02,
          -2.25512028e-03,  -1.86704636e-04],
        [  1.79502029e-03,   5.95901276e-03,  -2.25512028e-03,
           5.12504232e-02,  -4.11275670e-02],
        [ -7.13672371e-03,  -1.98922438e-03,  -1.86704636e-04,
          -4.11275670e-02,   5.14488228e-02]],

       [[  4.80219488e-01,   2.43775999e-02,   9.94946101e-03,
           1.23031993e-02,   5.05287719e-03],
        [  2.43775999e-02,   4.66991519e-01,   1.95616821e-02,
          -6.30387944e-02,  -1.13756577e-02],
        [  9.94946101e-03,   1.95616821e-02,   2.64526160e-02,
          -3.77533055e-02,   1.45396815e-02],
        [  1.23031993e-02,  -6.30387944e-02,  -3.77533055e-02,
           1.43254209e-01,  -4.74133580e-02],
        [  5.05287719e-03,  -1.13756577e-02,   1.45396815e-02,
          -4.74133580e-02,   4.35961754e-02]]])

